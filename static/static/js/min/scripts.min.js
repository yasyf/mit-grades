Grades.factory("API", function() {
  var API;
  API = {
    get: function(action, qs) {
      if (qs == null) {
        qs = {};
      }
      return $.ajax({
        type: 'GET',
        url: "/api/" + action + "?" + ($.param(qs))
      });
    },
    "delete": function(action, data, qs) {
      if (qs == null) {
        qs = {};
      }
      return $.ajax({
        type: 'DELETE',
        url: "/api/" + action + "?" + ($.param(qs)),
        data: data || {}
      });
    },
    post: function(action, data, qs) {
      if (qs == null) {
        qs = {};
      }
      return $.ajax({
        type: 'POST',
        url: "/api/" + action + "?" + ($.param(qs)),
        data: JSON.stringify(data),
        contentType: 'application/json',
        dataType: 'json'
      });
    }
  };
  return API;
});

Grades.controller('IndexCtrl', [
  '$scope', '$window', '$timeout', 'API', '$cookies', function($scope, $window, $timeout, API, $cookies) {
    var checkAuth;
    $scope.data = angular.fromJson($cookies.data || '{}');
    $scope.user = {};
    $scope.auth = false;
    checkAuth = function(data) {
      if (!(data.kerberos && data.password)) {
        return;
      }
      return API.post('check_auth', data).then(function(response) {
        return $timeout(function() {
          $scope.auth = response.authenticated;
          $scope.user = response.user;
          return $cookies.data = angular.toJson($scope.data);
        });
      });
    };
    return $scope.$watch('data', checkAuth, true);
  }
]);
