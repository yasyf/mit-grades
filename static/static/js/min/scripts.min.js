Grades.factory("API", function() {
  var API;
  API = {
    get: function(action, qs) {
      if (qs == null) {
        qs = {};
      }
      return $.ajax({
        type: 'GET',
        url: "/api/" + action + "?" + ($.param(qs))
      });
    },
    "delete": function(action, data, qs) {
      if (qs == null) {
        qs = {};
      }
      return $.ajax({
        type: 'DELETE',
        url: "/api/" + action + "?" + ($.param(qs)),
        data: data || {}
      });
    },
    post: function(action, data, qs) {
      if (qs == null) {
        qs = {};
      }
      return $.ajax({
        type: 'POST',
        url: "/api/" + action + "?" + ($.param(qs)),
        data: JSON.stringify(data),
        contentType: 'application/json',
        dataType: 'json'
      });
    }
  };
  return API;
});

Grades.controller('IndexCtrl', [
  '$scope', '$window', '$timeout', 'API', '$cookies', function($scope, $window, $timeout, API, $cookies) {
    var checkAuth, getGrades;
    $scope.good_bound = 0.86;
    $scope.data = angular.fromJson($cookies.data || '{}');
    $scope.user = {};
    $scope.grades = {};
    $scope.status = 'Login To Begin';
    $scope.auth = false;
    $scope.selected = null;
    checkAuth = function(data) {
      if (!(data.kerberos && data.password)) {
        return;
      }
      $scope.status = 'Authenticating';
      return API.post('check_auth', data).then(function(response) {
        return $timeout(function() {
          $scope.auth = response.authenticated;
          $scope.user = response.user;
          $cookies.data = angular.toJson($scope.data);
          if (!response.authenticated) {
            return $scope.status = 'Login To Begin';
          }
        });
      });
    };
    getGrades = function(auth) {
      if (!auth) {
        return;
      }
      $scope.status = 'Loading';
      return API.post('grades', $scope.data).then(function(response) {
        return $timeout(function() {
          $scope.grades = response.grades;
          return $scope.status = null;
        });
      });
    };
    $scope.$watch('data', checkAuth, true);
    $scope.$watch('auth', getGrades);
    $scope.remove_blank_categories = function(category) {
      return category.avg > 0;
    };
    return $scope.select_category = function(category) {
      if ($scope.selected === category) {
        return $scope.selected = null;
      } else {
        return $scope.selected = category;
      }
    };
  }
]);
